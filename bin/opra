#!/usr/bin/env node

var http = require('http');
var connect = require('connect');
var fs = require('fs');
var path = require('path');
var jit = require('express-jit-coffee');
var powerfs = require('powerfs');
var optimist = require('optimist');
var opra = require('../src/opra.js');

var argv = optimist
  .usage('Runs a web server in the given directory, preprocessing all files using opra')
  .describe('root', 'Root directory from where to run the server')
  .describe('port', 'Port to run the web server on')
  .describe('not-found', 'A file to respond with instead of 404')
  .describe('version', 'Print the current version number')
  .describe('help', 'Show this help message')
  .default('port', 7000)
  .default('root', '.')
  .alias('root', 'r')
  .alias('port', 'p')
  .alias('not-found', 'n')
  .alias('version', 'v')
  .alias('help', 'h')
  .argv;

if (argv.help) {
  console.log(optimist.help());
  return;
}
if (argv.version) {
  fs.readFile(path.join(__dirname, '../package.json'), 'utf8', function(err, data) {
    console.log(err ? err : JSON.parse(data).version);
  });
  return;
}

var port = argv.port;
var dir = path.resolve(process.cwd(), argv.root);
var fourofour = argv['not-found'] ? path.relative(argv.root, argv['not-found']) : null;

var app = connect().use(opra.serve(dir)).use(jit(dir)).use(connect.static(dir));

if (fourofour) {
  app.use(function(req, res, next) {
    if (req.headers.accept.indexOf('text/html') != -1) {
      req.url = '/' + fourofour;
    }
    next();
  }).use(opra.serve(dir));
}

http.createServer(app).listen(port);
console.log("Serving " + dir + " at port " + port + " with " + (fourofour || 'no response') + " for 404's");
